@{Layout = null;}@model IEnumerable<McoEasyTool.Pool>

<script type="text/javascript">
    jQuery(document).ready(function () {
        BESR_CONTROLLER = "McoBesr/";
        BESR_MODULE = "BESR";

        var TODAY = new Date();
        var DAY = TODAY.getDay();
        var WEEKDAY = ["Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Quotidien"];

        $("#mco-besr-div .uncheckedpool td.checkday").each(function () {
            if ($(this).text().trim() == DAY || $(this).text().trim() == 7) {
                $(this).closest("tr").removeClass("uncheckedpool");
                $(this).closest("tr").addClass("checkedpool");
                $(this).closest("tr").find(".checkpool").trigger("click");
            }
        });

        $("#mco-besr-div .dayweek").each(function () {
            $(this).text(WEEKDAY[parseInt($(this).text().trim())]);
        });

        $("#mco-besr-div .uncheckedpool td, .checkedpool td").click(function () {
            if ($(this).find(".checkpool").length == 0) {
                checkbox = $(this).closest("tr").find("td").find(".checkpool");
                checkbox.trigger("click");
            }
        });

        $("#mco-besr-div .checkpool").change(function () {
            line = $(this).closest("tr");
            if ($(this).prop("checked") == true) {
                line.removeClass("uncheckedpool");
                line.addClass("checkedpool");
            }
            else {
                line.removeClass("checkedpool");
                line.addClass("uncheckedpool");
                $("#mco-besr-div #CheckAllboxes").prop("checked", false);
            }
        })

        $("#mco-besr-div #CheckAllboxes").change(function () {
            if ($(this).prop("checked")) {
                $("#mco-besr-div .checkpool").each(function () {
                    $(this).prop("checked", true);
                    $(this).trigger("change");
                });
            }
            else {
                $("#mco-besr-div .checkpool").each(function () {
                    $(this).prop("checked", false);
                    $(this).trigger("change");
                });
            }
        });

        $("#mco-besr-div #check-launcher").click(function () {
            list = "";
            names = "";
            autobesr = $("#mco-besr-div #autobesr").prop("checked");
            $("#mco-besr-div .checkpool").each(function () {
                if ($(this).prop("checked") == true) {
                    list += $(this).attr("id") + ";";
                    names += $(this).val() + "\n";
                }
            })
            if (list == "") {
                alert("Vous devez sélectionner au moins un Pool");
                return false;
            }
            list = list.substr(0, list.length - 1);
            message = "Voulez-vous lancer la vérification pour les Pools : \n" + names;
            if (autobesr == true) {
                message += "Les sauvegardes seront automatiquement lancées pour les serveurs KO \n";
            }
            else {
                message += "Les sauvegardes ne seront pas lancées pour les serveurs KO \n";
            }
            launch = confirm(message);
            if (!launch) {
                return false;
            }
            success = false;
            BESR_MCO_DIV.prepend(loadinggif);
            $.ajax({
                url: SITENAME + BESR_CONTROLLER + 'BesrChecker',
                type: "POST",
                data: { list: list, autobesr: autobesr },
                success: function (data) {
                    if (data.response == "OK") {
                        success = true;
                        pools = data.pools;
                        autobesr = data.autobesr;
                        backupemailId = data.email;
                        email = "" +
                                    "<label class='ReadyEmail-label'>Destinataires: </label>" +
                                    " <input type='text' id='input-recipient'class='ReadyEmail-input'/><br />" +
                                    "<input type='button' id='input-button' onClick='SendBackupEmail(" + backupemailId + "," + autobesr.toLowerCase() + ");'class='ReadyEmail-submit' value='Envoyer' />" +
                                    "<label class='ReadyEmail-label'>Sujet : </label>" +
                                    "<input type='text' id='input-subject'  class='ReadyEmail-input'/><br />" +
                                    "<div id='input-body'  class='ReadyEmail-body'>" +
                                    "<textarea id='input-message' placeholder='Ajoutez un message ici...' " +
                                    "style='margin-left:10px;width:800px;border:0px solid #000;'" +
                                    "class='ReadyEmail-input'></textarea></div>";
                        BESR_MCO_DIV.html(email);

                        AddressParser();
                    }
                    else {
                        success = false;
                        alert(data.errors);
                    }
                },
                error: function (errorThrown) {
                    alert('Erreur lors de communication avec le serveur');
                    NAV_HOME_BTN.trigger("click");
                },
                complete: function () {
                    if (success) {
                        $.ajax({
                            url: SITENAME + BESR_CONTROLLER + 'OpenPoolsEmail/' + backupemailId,
                            type: "POST",
                            data: { pools: pools, autobesr: autobesr },
                            success: function (content) {
                                failedservers = content.failedservers;
                                BESR_MCO_DIV.find("#input-recipient").eq(0).val(content.recipient);
                                BESR_MCO_DIV.find("#input-subject").eq(0).val(content.subject);
                                BESR_MCO_DIV.find("#input-body").eq(0).append(content.body);
                                BESR_MCO_DIV.prepend(failedservers);
                                $("#mco-besr-div #autobesr-div").css("visibility", "hidden");
                                $("#mco-besr-div #autobesr-div").css("display", "none");
                            },
                            error: function (errorThrown) {
                                alert('Erreur lors de communication avec le serveur');
                                NAV_HOME_BTN.trigger("click");
                            },
                            complete: function () { }
                        });
                    }
                }
            });
        });


        //----------------------------------------------------------
        $("#mco-besr-div .deleter").click(function () {
            deletor = confirm("Voulez vous réellement supprimer ce serveur de la liste?");
            line = $(this).closest("tr");
            if (deletor) {
                serverId = $(this).closest("td").find(".action-id-getter").val();
                BESR_MCO_DIV.prepend(loadinggif);
                $.ajax({
                    url: SITENAME + BESR_CONTROLLER + 'DeleteBackupServer/' + serverId,
                    type: "GET",
                    success: function (response) {
                        alert(response);
                    },
                    error: function (error) {
                        alert(error.responseText);
                    },
                    complete: function () {
                        //line.css("visibility","hidden");
                        //line.css("display","none");
                        line.prop("disabled", "disabled");
                    }
                });
            }
        });

        $("#mco-besr-div .backup-launcher").click(function () {
            launch = confirm("Voulez vous vraiment lancer la sauvegarde pour ce serveur maintenant? \n" +
                "Les anciens fichiers de sauvegardes de ce serveur seront éventuellement supprimés.");
            if (launch) {
                serverId = $(this).closest("td").find(".action-id-getter").val();
                line = $(this).closest("tr");
                success = false;
                BESR_MCO_DIV.prepend(loadinggif);
                $.ajax({
                    url: SITENAME + BESR_CONTROLLER + 'ServiceLauncher/' + serverId,
                    type: "GET",
                    success: function (content) {
                        if ((content.indexOf('Backup Exec System Recovery: Running: Manual') != -1) &&
                                        (content.indexOf('SymSnapService: Running: Manual') != -1)
                                    ) {
                            success = true;
                        }
                    },
                    error: function (error) {
                        alert(error.responseText);
                    },
                    complete: function () {
                        if (success) {
                            $.ajax({
                                url: SITENAME + BESR_CONTROLLER + 'BackupExecLauncher/' + serverId,
                                type: "GET",
                                success: function (content) {
                                    alert(content);
                                },
                                error: function (error) {
                                    alert(error.responseText);
                                },
                                complete: function () {
                                    line.prop("disabled", "disabled");
                                }
                            });
                        }
                    }
                });
            }
            else {
                return false;
            }
        });

        $("#mco-besr-div .backup-launcher-btn").click(function () {
            selectedServers = "";

            $("#mco-besr-div .selected-servers").each(function () {
                if ($(this).is(':checked')) {
                    selectedServers += $(this).closest("td").find(".action-id-getter").val() + ", ";
                }
            });

            if (selectedServers == "") {
                alert("Vous devez sélectionner au moins un serveur");
                return false;
            }
            else {
                BESR_MCO_DIV.prepend(loadinggif);
                $.ajax({
                    url: SITENAME + BESR_CONTROLLER + 'BackupExecLauncherServers/',
                    type: "POST",
                    data: { selectedServers: selectedServers },
                    success: function (content) {
                        alert(content);
                    },
                    error: function (error) {
                        alert(error.responseText);
                    },
                    complete: function () {

                    }
                });
            }
        });
    });
</script>

    <div class="div-besr-launcher">
        <hgroup>
            <h2 class="page-title">Lancer la vérification maintenant</h2>
        </hgroup>
    <p class="page-title-info warning"></p>
        <span>
            Veuillez sélectionner les Pools dont vous désirez vérifier les sauvegardes.
            Les Pools devant être vérifiés aujourd'hui ont été sélectionnées par défaut,
            Vous pouvez cependant modifier ce choix.
        </span>
        <br /><br />
        <span class="nav-info">
            Veuillez cocher cette case si vous désirez que les sauvegardes soient lancées
            automatiquement pour les serveurs ne respectant pas les conditions requises.
        </span><br />
        <input id="check-launcher" type="button" class="besr-controls-btn" value="Lancer le check"
        title="Lancer la vérification de sauvegarde pour les Pools sélectionnés"/><br /><br />
        <input type="checkbox" name="autobesr" style="height:15px; width:20px;" id="autobesr" value="autobesr"/>
        <span class="warning">Lancer les sauvegardes pour les serveurs KO</span><br />
        <input type="checkbox" style="height:15px; width:20px;" id="CheckAllboxes"/>
        <span>
           Sélectionner tous tous les Pools
        </span><br /><br />
        <table id="pool-table" class="pool-select-table">
            <thead>
                <tr class="item-summary-thead">
                    <th>Pool</th>
                    <th> </th>
                    <th>Jour de sauvegarde</th>
                    <th>Jour de check</th>
                </tr>
            </thead>
            <tbody> 
                @foreach (var item in Model)
                   { 
                <tr class="uncheckedpool">
                    <td>
                        @Html.DisplayFor(modelItem => item.Name) 
                    </td>
                    <td>
                        <input type="checkbox" name="pool-@Html.DisplayFor(modelItem => item.Id) "
                            class="checkpool" value="@Html.DisplayFor(modelItem => item.Name) " 
                            id="pool-@Html.DisplayFor(modelItem => item.Id) "
                            />
                    </td>
                    <td class="dayweek">
                        @Html.DisplayFor(modelItem => item.BackupDay)
                    </td>
                    <td class="dayweek checkday">
                        @Html.DisplayFor(modelItem => item.CheckDay)
                    </td>
                </tr>
                }              
            </tbody>
        </table>
    </div> 

